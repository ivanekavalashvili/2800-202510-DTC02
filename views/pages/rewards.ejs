<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <body>
        <div class="reward-btn mt-5 md:mt-24">
            <div class="reward-header">
                <h3>Your Rewards</h3>
            </div>
        </div>
        <div id="AddRewardModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" id="closeAddRewardModal">&times;</span>
                <h2>Add a Reward</h2>
                <form id="addRewardForm">
                    <input class="input" type="text" name="rewardTitle" placeholder="Title" required />
                    <input class="input" type="text" name="description" placeholder="description" required />
                    <input class="input" type="text" name="pointsNeeded" placeholder="cost" required />
                    <button type="submit" class="login-btn">Create Reward</button>
                </form>
            </div>
        </div>
        <div id="editRewardModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" id="closeEditRewardModal">&times;</span>
                <h2>Edit Reward</h2>
                <form id="editRewardForm">
                    <input type="hidden" name="rewardId" />
                    <input class="input" type="text" name="rewardTitle" placeholder="Title" required />
                    <input class="input" type="text" name="description" placeholder="description" required />
                    <input class="input" type="text" name="pointsNeeded" placeholder="cost" required />
                    <div style="display: flex; justify-content: space-between; gap: 10px;">
                        <button type="submit" class="nav-btn">Save Changes</button>
                        <button type="button" id="deleteRewardBtn" class="nav-btn">
                            Delete
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <% if (rewards.length===0) { %>
            <p>No rewards created yet.</p>
        <% } else { %>
            <div class="reward-list">
                <% rewards.forEach(reward=> { %>
                    <div class="reward-card" data-id="<%= reward._id %>">
                        <div class="title">
                            <%= reward.rewardTitle %>
                        </div>
                        <div class="description">
                            <%= reward.description %>
                        </div>
                        <div class="points">
                            <%= reward.pointsNeeded %> pts
                        </div>
                        <% if (role==='parent' ) { %>
                            <button class="edit-reward-btn" data-id="<%= reward._id %>"
                                data-title="<%= reward.rewardTitle %>" data-description="<%= reward.description %>"
                                data-points="<%= reward.pointsNeeded %>">
                                Edit
                            </button>
                            <% } else if (role==='kid' ) { %>
                                <button class="claim-reward-btn" data-id="<%= reward._id %>"
                                    data-points="<%= reward.pointsNeeded %>" <%=user.points>= reward.pointsNeeded ?
                                    '' : 'disabled' %>>
                                    <%= user.points>= reward.pointsNeeded ? 'Claim Reward' : 'Not Enough Points' %>
                                </button>
                                <% } %>
                    </div>
                <% }) %>
            </div>
        <% } %>

        <div class="reward-btn mt-3">
        <% if (role==="parent" ) { %>
            <a href="#" id="openAddRewardModal" class="nav-btn">Create Reward</a> 
        <% } %>
        </div>
    </body>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const modal = document.getElementById("AddRewardModal");
            const openBtn = document.getElementById("openAddRewardModal");
            const closeBtn = document.getElementById("closeAddRewardModal");
            const form = document.getElementById("addRewardForm");
            const editModal = document.getElementById("editRewardModal");
            const closeEditBtn = document.getElementById("closeEditRewardModal");
            const editForm = document.getElementById("editRewardForm");
            const deleteBtn = document.getElementById("deleteRewardBtn");


            if (modal && openBtn && closeBtn) {
                openBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    modal.style.display = "flex";
                });

                closeBtn.addEventListener("click", () => {
                    modal.style.display = "none";
                });

                window.addEventListener("click", (event) => {
                    if (event.target === modal) {
                        modal.style.display = "none";
                    }
                });
            }

            document.querySelectorAll(".edit-reward-btn").forEach(button => {
                button.addEventListener("click", () => {

                    editForm.rewardId.value = button.dataset.id;
                    editForm.rewardTitle.value = button.dataset.title;
                    editForm.description.value = button.dataset.description;
                    editForm.pointsNeeded.value = button.dataset.points;


                    editModal.style.display = "flex";
                });
            });


            closeEditBtn.addEventListener("click", () => {
                editModal.style.display = "none";
            });

            deleteBtn.addEventListener("click", async () => {
                const rewardId = editForm.rewardId.value;

                if (!rewardId) return alert("No reward selected.");
                if (!confirm("Are you sure you want to delete this reward?")) return;

                const res = await fetch(`/rewards/${rewardId}`, {
                    method: "DELETE"
                });

                const data = await res.json();
                if (res.ok) {
                    alert("Reward deleted.");
                    editModal.style.display = "none";
                    location.reload();
                } else {
                    alert(data.message || "Error deleting reward.");
                }
            });


            if (form) {
                form.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const title = form.rewardTitle.value
                    const description = form.description.value;
                    const cost = form.pointsNeeded.value

                    const res = await fetch("/rewards", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ title, description, cost }),
                    });

                    const data = await res.json();
                    if (res.ok) {
                        alert("Reward Created");
                        form.reset();
                        modal.style.display = "none";
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                });
            }
            if (editForm) {
                editForm.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const rewardId = editForm.rewardId.value;
                    const title = editForm.rewardTitle.value;
                    const description = editForm.description.value;
                    const cost = editForm.pointsNeeded.value;

                    const res = await fetch(`/rewards/${rewardId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ title, description, cost }),
                    });

                    const data = await res.json();
                    if (res.ok) {
                        alert("Reward updated!");
                        editForm.reset();
                        editModal.style.display = "none";
                        location.reload();
                    } else {
                        alert(data.message || "Failed to update reward.");
                    }
                });
            }

            // Add claim reward functionality for kids
            document.querySelectorAll(".claim-reward-btn").forEach(button => {
                button.addEventListener("click", async () => {
                    const rewardId = button.dataset.id;
                    const pointsCost = parseInt(button.dataset.points);

                    if (!confirm("Are you sure you want to claim this reward?")) return;

                    try {
                        const res = await fetch(`/rewards/${rewardId}/claim`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" }
                        });

                        const data = await res.json();
                        if (res.ok) {
                            // Update points display in header
                            const pointsDisplay = document.getElementById('pointsDisplay');
                            if (pointsDisplay && data.newPoints !== undefined) {
                                pointsDisplay.textContent = `Points: ${data.newPoints}`;
                            }
                            alert("Reward claimed successfully!");
                            location.reload();
                        } else {
                            alert(data.message || "Failed to claim reward.");
                        }
                    } catch (error) {
                        console.error("Error claiming reward:", error);
                        alert("Error claiming reward. Please try again.");
                    }
                });
            });

        });
    </script>
    </body>
</html>